<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forecasting Using Multiple Models • sweep</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Forecasting Using Multiple Models">
<meta property="og:description" content="sweep">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-76139189-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-76139189-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sweep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/SW00_Introduction_to_sweep.html">Introduction to sweep</a>
    </li>
    <li>
      <a href="../articles/SW01_Forecasting_Time_Series_Groups.html">Forecasting time series groups</a>
    </li>
    <li>
      <a href="../articles/SW02_Forecasting_Multiple_Models.html">Forecasting multiple models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/business-science/sweep">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="SW02_Forecasting_Multiple_Models_files/header-attrs-2.3/header-attrs.js"></script><script src="SW02_Forecasting_Multiple_Models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Forecasting Using Multiple Models</h1>
                        <h4 class="author">Matt Dancho</h4>
            
            <h4 class="date">2020-07-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/business-science/sweep/blob/master/vignettes/SW02_Forecasting_Multiple_Models.Rmd"><code>vignettes/SW02_Forecasting_Multiple_Models.Rmd</code></a></small>
      <div class="hidden name"><code>SW02_Forecasting_Multiple_Models.Rmd</code></div>

    </div>

    
    
<blockquote>
<p>Extending <code>broom</code> to time series forecasting</p>
</blockquote>
<p>One of the most powerful benefits of <code>sweep</code> is that it helps forecasting at scale within the “tidyverse”. There are two common situations:</p>
<ol style="list-style-type: decimal">
<li>Applying a model to groups of time series</li>
<li>Applying multiple models to a time series</li>
</ol>
<p>In this vignette we’ll review how <code>sweep</code> can help the <strong>second situation</strong>: <em>Applying multiple models to a time series</em>.</p>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Before we get started, load the following packages.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)</pre></body></html></div>
<pre><code>## Warning: package 'ggplot2' was built under R version 3.6.2</code></pre>
<pre><code>## Warning: package 'tidyr' was built under R version 3.6.2</code></pre>
<pre><code>## Warning: package 'purrr' was built under R version 3.6.2</code></pre>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyquant</span>)</pre></body></html></div>
<pre><code>## Warning: package 'lubridate' was built under R version 3.6.2</code></pre>
<pre><code>## Warning: package 'zoo' was built under R version 3.6.2</code></pre>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">timetk</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">sweep</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">forecast</span>)</pre></body></html></div>
<pre><code>## Warning: package 'forecast' was built under R version 3.6.2</code></pre>
</div>
<div id="forecasting-gasoline-prices" class="section level1">
<h1 class="hasAnchor">
<a href="#forecasting-gasoline-prices" class="anchor"></a>Forecasting Gasoline Prices</h1>
<p>To start, let’s get some data from the FRED data base using <code>tidyquant</code>. We’ll use <code><a href="https://rdrr.io/pkg/tidyquant/man/tq_get.html">tq_get()</a></code> to retrieve the Gasoline Prices from 1990 through today (2020-07-10).</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">gas_prices_monthly_raw</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/tq_get.html">tq_get</a></span>(
    <span class="kw">x</span>    <span class="kw">=</span> <span class="st">"GASREGCOVM"</span>,
    <span class="kw">get</span>  <span class="kw">=</span> <span class="st">"economic.data"</span>,
    <span class="kw">from</span> <span class="kw">=</span> <span class="st">"1990-01-01"</span>,
    <span class="kw">to</span>   <span class="kw">=</span> <span class="st">"2016-12-31"</span>)
<span class="no">gas_prices_monthly_raw</span></pre></body></html></div>
<pre><code>## # A tibble: 316 x 3
##    symbol     date       price
##    &lt;chr&gt;      &lt;date&gt;     &lt;dbl&gt;
##  1 GASREGCOVM 1990-09-01  1.26
##  2 GASREGCOVM 1990-10-01  1.34
##  3 GASREGCOVM 1990-11-01  1.32
##  4 GASREGCOVM 1990-12-01 NA   
##  5 GASREGCOVM 1991-01-01 NA   
##  6 GASREGCOVM 1991-02-01  1.09
##  7 GASREGCOVM 1991-03-01  1.04
##  8 GASREGCOVM 1991-04-01  1.08
##  9 GASREGCOVM 1991-05-01  1.13
## 10 GASREGCOVM 1991-06-01  1.13
## # … with 306 more rows</code></pre>
<p>Upon a brief inspection, the data contains 2 <code>NA</code> values that will need to be dealt with.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">gas_prices_monthly_raw</span>$<span class="no">price</span>)</pre></body></html></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##   0.900   1.138   1.615   1.974   2.697   4.002       2</code></pre>
<p>We can use the <code>fill()</code> from the <code>tidyr</code> package to help deal with these data. We first fill down and then fill up to use the previous and then post days prices to fill in the missing data.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">gas_prices_monthly</span> <span class="kw">&lt;-</span> <span class="no">gas_prices_monthly_raw</span> <span class="kw">%&gt;%</span>
    <span class="fu">fill</span>(<span class="no">price</span>, <span class="kw">.direction</span> <span class="kw">=</span> <span class="st">"down"</span>) <span class="kw">%&gt;%</span>
    <span class="fu">fill</span>(<span class="no">price</span>, <span class="kw">.direction</span> <span class="kw">=</span> <span class="st">"up"</span>)</pre></body></html></div>
<p>We can now visualize the data.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">gas_prices_monthly</span> <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">price</span>)) +
    <span class="fu">geom_line</span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/palette_tq.html">palette_light</a></span>()<span class="kw">[[</span><span class="fl">1</span>]]) +
    <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Gasoline Prices, Monthly"</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="st">""</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"USD"</span>) +
    <span class="fu">scale_y_continuous</span>(<span class="kw">labels</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/label_dollar.html">dollar</a></span>) +
    <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/theme_tq.html">theme_tq</a></span>()</pre></body></html></div>
<p><img src="SW02_Forecasting_Multiple_Models_files/figure-html/unnamed-chunk-6-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>Monthly periodicity might be a bit granular for model fitting. We can easily switch periodicity to quarterly using <code><a href="https://rdrr.io/pkg/tidyquant/man/tq_mutate.html">tq_transmute()</a></code> from the <code>tidyquant</code> package along with the periodicity aggregation function <code>to.period</code> from the <code>xts</code> package. We’ll convert the date to <code>yearqtr</code> class which is regularized.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">gas_prices_quarterly</span> <span class="kw">&lt;-</span> <span class="no">gas_prices_monthly</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/tq_mutate.html">tq_transmute</a></span>(<span class="kw">mutate_fun</span> <span class="kw">=</span> <span class="no">to.period</span>, <span class="kw">period</span> <span class="kw">=</span> <span class="st">"quarters"</span>)
<span class="no">gas_prices_quarterly</span></pre></body></html></div>
<pre><code>## # A tibble: 106 x 2
##    date       price
##    &lt;date&gt;     &lt;dbl&gt;
##  1 1990-09-01  1.26
##  2 1990-12-01  1.32
##  3 1991-03-01  1.04
##  4 1991-06-01  1.13
##  5 1991-09-01  1.11
##  6 1991-12-01  1.08
##  7 1992-03-01  1.01
##  8 1992-06-01  1.14
##  9 1992-09-01  1.12
## 10 1992-12-01  1.08
## # … with 96 more rows</code></pre>
<p>Another quick visualization to show the reduction in granularity.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">gas_prices_quarterly</span> <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">price</span>)) +
    <span class="fu">geom_line</span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/palette_tq.html">palette_light</a></span>()<span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">size</span> <span class="kw">=</span> <span class="fl">1</span>) +
    <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Gasoline Prices, Quarterly"</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="st">""</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"USD"</span>) +
    <span class="fu">scale_y_continuous</span>(<span class="kw">labels</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/label_dollar.html">dollar</a></span>) +
    <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"5 years"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y"</span>) +
    <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/theme_tq.html">theme_tq</a></span>()</pre></body></html></div>
<p><img src="SW02_Forecasting_Multiple_Models_files/figure-html/unnamed-chunk-8-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="performing-forecasts-using-multiple-models" class="section level1">
<h1 class="hasAnchor">
<a href="#performing-forecasts-using-multiple-models" class="anchor"></a>Performing Forecasts Using Multiple Models</h1>
<p>In this section we will use three models to forecast gasoline prices:</p>
<ol style="list-style-type: decimal">
<li>ARIMA</li>
<li>ETS</li>
<li>BATS</li>
</ol>
<div id="multiple-models-concept" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-models-concept" class="anchor"></a>Multiple Models Concept</h2>
<p>Before we jump into modeling, let’s take a look at the multiple model process from <a href="http://r4ds.had.co.nz/many-models.html#from-a-named-list">R for Data Science, Chapter 25 Many Models</a>. We first create a data frame from a named list. The example below has two columns: “f” the functions as text, and “params” a nested list of parameters we will pass to the respective function in column “f”.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(
  <span class="kw">f</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"runif"</span>, <span class="st">"rpois"</span>, <span class="st">"rnorm"</span>),
  <span class="kw">params</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">10</span>),
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">lambda</span> <span class="kw">=</span> <span class="fl">10</span>),
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">mean</span> <span class="kw">=</span> -<span class="fl">3</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fl">10</span>)
  )
)
<span class="no">df</span></pre></body></html></div>
<pre><code>## # A tibble: 3 x 2
##   f     params          
##   &lt;chr&gt; &lt;list&gt;          
## 1 runif &lt;named list [1]&gt;
## 2 rpois &lt;named list [2]&gt;
## 3 rnorm &lt;named list [3]&gt;</code></pre>
<p>We can also view the contents of the <code>df$params</code> column to understand the underlying structure. Notice that there are three primary levels and then secondary levels containing the name-value pairs of parameters. This format is important.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">df</span>$<span class="no">params</span></pre></body></html></div>
<pre><code>## [[1]]
## [[1]]$n
## [1] 10
## 
## 
## [[2]]
## [[2]]$n
## [1] 5
## 
## [[2]]$lambda
## [1] 10
## 
## 
## [[3]]
## [[3]]$n
## [1] 10
## 
## [[3]]$mean
## [1] -3
## 
## [[3]]$sd
## [1] 10</code></pre>
<p>Next we apply the functions to the parameters using a special function, <code>invoke_map()</code>. The parameter lists in the “params” column are passed to the function in the “f” column. The output is in a nested list-column named “out”.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">df_out</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">out</span> <span class="kw">=</span> <span class="fu">invoke_map</span>(<span class="no">f</span>, <span class="no">params</span>))
<span class="no">df_out</span></pre></body></html></div>
<pre><code>## # A tibble: 3 x 3
##   f     params           out       
##   &lt;chr&gt; &lt;list&gt;           &lt;list&gt;    
## 1 runif &lt;named list [1]&gt; &lt;dbl [10]&gt;
## 2 rpois &lt;named list [2]&gt; &lt;int [5]&gt; 
## 3 rnorm &lt;named list [3]&gt; &lt;dbl [10]&gt;</code></pre>
<p>And, here’s the contents of “out”, which is the result of mapping a list of functions to a list of parameters. Pretty powerful!</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">df_out</span>$<span class="no">out</span></pre></body></html></div>
<pre><code>## [[1]]
##  [1] 0.21042348 0.06970687 0.24918314 0.90943759 0.23470174 0.72033531
##  [7] 0.53570992 0.02829043 0.99693010 0.58727464
## 
## [[2]]
## [1] 10 13  6 10 16
## 
## [[3]]
##  [1]   4.340660  14.519928  -7.516458  -4.447925  -8.686418 -11.569661
##  [7]  -4.223564   2.121284  14.137151 -10.436296</code></pre>
<p>Take a minute to understand the conceptual process of the <code>invoke_map</code> function and specifically the parameter setup. Once you are comfortable, we can move on to model implementation.</p>
</div>
<div id="multiple-model-implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-model-implementation" class="anchor"></a>Multiple Model Implementation</h2>
<p>We’ll need to take the following steps to in an actual forecast model implementation:</p>
<ol style="list-style-type: decimal">
<li>Coerce the data to time series</li>
<li>Build a model list using nested lists</li>
<li>Create the the model data frame</li>
<li>Invoke a function map</li>
</ol>
<p>This is easier than it sounds. Let’s start by coercing the univariate time series with <code><a href="https://rdrr.io/pkg/timetk/man/tk_ts.html">tk_ts()</a></code>.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">gas_prices_quarterly_ts</span> <span class="kw">&lt;-</span> <span class="no">gas_prices_quarterly</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/timetk/man/tk_ts.html">tk_ts</a></span>(<span class="kw">select</span> <span class="kw">=</span> -<span class="no">date</span>, <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1990</span>, <span class="fl">3</span>), <span class="kw">freq</span> <span class="kw">=</span> <span class="fl">4</span>)</pre></body></html></div>
<pre><code>## Warning: `select_()` is deprecated as of dplyr 0.7.0.
## Please use `select()` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">gas_prices_quarterly_ts</span></pre></body></html></div>
<pre><code>##       Qtr1  Qtr2  Qtr3  Qtr4
## 1990             1.258 1.324
## 1991 1.040 1.128 1.109 1.076
## 1992 1.013 1.145 1.122 1.078
## 1993 1.052 1.097 1.050 1.014
## 1994 1.008 1.078 1.144 1.060
## 1995 1.059 1.186 1.108 1.066
## 1996 1.129 1.243 1.200 1.233
## 1997 1.197 1.189 1.216 1.119
## 1998 1.014 1.048 0.994 0.923
## 1999 0.961 1.095 1.239 1.261
## 2000 1.498 1.612 1.525 1.418
## 2001 1.384 1.548 1.506 1.072
## 2002 1.221 1.341 1.363 1.348
## 2003 1.636 1.452 1.616 1.448
## 2004 1.689 1.910 1.841 1.800
## 2005 2.063 2.123 2.862 2.174
## 2006 2.413 2.808 2.501 2.284
## 2007 2.503 3.024 2.817 2.984
## 2008 3.215 3.989 3.709 1.669
## 2009 1.937 2.597 2.480 2.568
## 2010 2.742 2.684 2.678 2.951
## 2011 3.509 3.628 3.573 3.220
## 2012 3.774 3.465 3.801 3.256
## 2013 3.648 3.576 3.474 3.209
## 2014 3.474 3.626 3.354 2.488
## 2015 2.352 2.700 2.275 1.946
## 2016 1.895 2.303 2.161 2.192</code></pre>
<p>Next, create a nested list using the function names as the first-level keys (this is important as you’ll see in the next step). Pass the model parameters as name-value pairs in the second level.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">models_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">auto.arima</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        <span class="kw">y</span> <span class="kw">=</span> <span class="no">gas_prices_quarterly_ts</span>
        ),
    <span class="kw">ets</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        <span class="kw">y</span> <span class="kw">=</span> <span class="no">gas_prices_quarterly_ts</span>,
        <span class="kw">damped</span> <span class="kw">=</span> <span class="fl">TRUE</span>
    ),
    <span class="kw">bats</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        <span class="kw">y</span> <span class="kw">=</span> <span class="no">gas_prices_quarterly_ts</span>
    )
)</pre></body></html></div>
<p>Now, convert to a data frame using the function, <code>enframe()</code> that turns lists into tibbles. Set the arguments <code>name = "f"</code> and <code>value = "params"</code>. In doing so we get a bonus: the model names are the now convieniently located in column “f”.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">models_tbl</span> <span class="kw">&lt;-</span> <span class="fu">enframe</span>(<span class="no">models_list</span>, <span class="kw">name</span> <span class="kw">=</span> <span class="st">"f"</span>, <span class="kw">value</span> <span class="kw">=</span> <span class="st">"params"</span>)
<span class="no">models_tbl</span></pre></body></html></div>
<pre><code>## # A tibble: 3 x 2
##   f          params          
##   &lt;chr&gt;      &lt;list&gt;          
## 1 auto.arima &lt;named list [1]&gt;
## 2 ets        &lt;named list [2]&gt;
## 3 bats       &lt;named list [1]&gt;</code></pre>
<p>We are ready to invoke the map. Combine <code>mutate()</code> with <code>invoke_map()</code> as follows. Bada bing, bada boom, we now have models fitted using the parameters we defined previously.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">models_tbl_fit</span> <span class="kw">&lt;-</span> <span class="no">models_tbl</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">fit</span> <span class="kw">=</span> <span class="fu">invoke_map</span>(<span class="no">f</span>, <span class="no">params</span>))
<span class="no">models_tbl_fit</span></pre></body></html></div>
<pre><code>## # A tibble: 3 x 3
##   f          params           fit       
##   &lt;chr&gt;      &lt;list&gt;           &lt;list&gt;    
## 1 auto.arima &lt;named list [1]&gt; &lt;fr_ARIMA&gt;
## 2 ets        &lt;named list [2]&gt; &lt;ets&gt;     
## 3 bats       &lt;named list [1]&gt; &lt;bats&gt;</code></pre>
</div>
</div>
<div id="inspecting-the-model-fit" class="section level1">
<h1 class="hasAnchor">
<a href="#inspecting-the-model-fit" class="anchor"></a>Inspecting the Model Fit</h1>
<p>It’s a good point to review and understand the model output. We can review the model parameters, accuracy measurements, and the residuals using <code><a href="../reference/sw_tidy.html">sw_tidy()</a></code>, <code><a href="../reference/sw_glance.html">sw_glance()</a></code>, and <code><a href="../reference/sw_augment.html">sw_augment()</a></code>.</p>
<div id="sw_tidy" class="section level2">
<h2 class="hasAnchor">
<a href="#sw_tidy" class="anchor"></a>sw_tidy</h2>
<p>The tidying function returns the model parameters and estimates. We use the combination of <code>mutate</code> and <code>map</code> to iteratively apply the <code><a href="../reference/sw_tidy.html">sw_tidy()</a></code> function as a new column named “tidy”. Then we unnest and spread to review the terms by model function.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="no">models_tbl_fit</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">tidy</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">fit</span>, <span class="no">sw_tidy</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">unnest</span>(<span class="no">tidy</span>) <span class="kw">%&gt;%</span>
    <span class="fu">spread</span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">f</span>, <span class="kw">value</span> <span class="kw">=</span> <span class="no">estimate</span>)</pre></body></html></div>
<pre><code>## # A tibble: 20 x 6
##    params           fit        term              auto.arima       bats       ets
##    &lt;list&gt;           &lt;list&gt;     &lt;chr&gt;                  &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
##  1 &lt;named list [1]&gt; &lt;fr_ARIMA&gt; ar1                    0.834 NA         NA       
##  2 &lt;named list [1]&gt; &lt;fr_ARIMA&gt; ma1                   -0.964 NA         NA       
##  3 &lt;named list [1]&gt; &lt;fr_ARIMA&gt; sar1                   0.939 NA         NA       
##  4 &lt;named list [1]&gt; &lt;fr_ARIMA&gt; sma1                  -0.776 NA         NA       
##  5 &lt;named list [1]&gt; &lt;bats&gt;     alpha                 NA      0.588     NA       
##  6 &lt;named list [1]&gt; &lt;bats&gt;     ar.coefficients       NA     NA         NA       
##  7 &lt;named list [1]&gt; &lt;bats&gt;     beta                  NA     NA         NA       
##  8 &lt;named list [1]&gt; &lt;bats&gt;     damping.parameter     NA     NA         NA       
##  9 &lt;named list [1]&gt; &lt;bats&gt;     gamma.values          NA     -0.0262    NA       
## 10 &lt;named list [1]&gt; &lt;bats&gt;     lambda                NA      0.0000605 NA       
## 11 &lt;named list [1]&gt; &lt;bats&gt;     ma.coefficients       NA      0.256     NA       
## 12 &lt;named list [2]&gt; &lt;ets&gt;      alpha                 NA     NA          0.831   
## 13 &lt;named list [2]&gt; &lt;ets&gt;      b                     NA     NA         -0.0524  
## 14 &lt;named list [2]&gt; &lt;ets&gt;      beta                  NA     NA          0.000100
## 15 &lt;named list [2]&gt; &lt;ets&gt;      gamma                 NA     NA          0.0521  
## 16 &lt;named list [2]&gt; &lt;ets&gt;      l                     NA     NA          1.29    
## 17 &lt;named list [2]&gt; &lt;ets&gt;      phi                   NA     NA          0.837   
## 18 &lt;named list [2]&gt; &lt;ets&gt;      s0                    NA     NA          0.0469  
## 19 &lt;named list [2]&gt; &lt;ets&gt;      s1                    NA     NA         -0.0209  
## 20 &lt;named list [2]&gt; &lt;ets&gt;      s2                    NA     NA         -0.0407</code></pre>
</div>
<div id="sw_glance" class="section level2">
<h2 class="hasAnchor">
<a href="#sw_glance" class="anchor"></a>sw_glance</h2>
<p>Glance is one of the most powerful tools because it yields the model accuracies enabling direct comparisons between the fit of each model. We use the same process for used for tidy, except theres no need to spread to perform the comparison. We can see that the ARIMA model has the lowest AIC by far.</p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="no">models_tbl_fit</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">glance</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">fit</span>, <span class="no">sw_glance</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">unnest</span>(<span class="no">glance</span>, <span class="kw">.drop</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>## Warning: The `.drop` argument of `unnest()` is deprecated as of tidyr 1.0.0.
## All list-columns are now preserved.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<pre><code>## # A tibble: 3 x 15
##   f     params fit   model.desc sigma logLik   AIC   BIC     ME  RMSE   MAE
##   &lt;chr&gt; &lt;list&gt; &lt;lis&gt; &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 auto… &lt;name… &lt;fr_… ARIMA(1,1… 0.298  -20.6  51.2  64.4 0.0180 0.291 0.177
## 2 ets   &lt;name… &lt;ets&gt; ETS(M,Ad,… 0.118  -76.6 173.  200.  0.0149 0.292 0.170
## 3 bats  &lt;name… &lt;bat… BATS(0, {… 0.116  159.  179.  184.  0.0193 0.259 0.159
## # … with 4 more variables: MPE &lt;dbl&gt;, MAPE &lt;dbl&gt;, MASE &lt;dbl&gt;, ACF1 &lt;dbl&gt;</code></pre>
</div>
<div id="sw_augment" class="section level2">
<h2 class="hasAnchor">
<a href="#sw_augment" class="anchor"></a>sw_augment</h2>
<p>We can augment the models to get the residuals following the same procedure. We can pipe (<code><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></code>) the results right into <code>ggplot()</code> for plotting. Notice the ARIMA model has the largest residuals especially as the model index increases whereas the bats model has relatively low residuals.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">models_tbl_fit</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">augment</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">fit</span>, <span class="no">sw_augment</span>, <span class="kw">rename_index</span> <span class="kw">=</span> <span class="st">"date"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">unnest</span>(<span class="no">augment</span>) <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">.resid</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">f</span>)) +
    <span class="fu">geom_line</span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/palette_tq.html">palette_light</a></span>()<span class="kw">[[</span><span class="fl">2</span>]]) +
    <span class="fu">geom_point</span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/palette_tq.html">palette_light</a></span>()<span class="kw">[[</span><span class="fl">1</span>]]) +
    <span class="fu">geom_smooth</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"loess"</span>) +
    <span class="fu">facet_wrap</span>(~ <span class="no">f</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">3</span>) +
    <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Residuals Plot"</span>) +
    <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/theme_tq.html">theme_tq</a></span>()</pre></body></html></div>
<pre><code>## `geom_smooth()` using formula 'y ~ x'</code></pre>
<p><img src="SW02_Forecasting_Multiple_Models_files/figure-html/unnamed-chunk-19-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="forecasting-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#forecasting-the-model" class="anchor"></a>Forecasting the model</h1>
<p>Creating the forecast for the models is accomplished by mapping the <code>forecast</code> function. The next six quarters are forecasted withe the argument <code>h = 6</code>.</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="no">models_tbl_fcast</span> <span class="kw">&lt;-</span> <span class="no">models_tbl_fit</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">fcast</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">fit</span>, <span class="no">forecast</span>, <span class="kw">h</span> <span class="kw">=</span> <span class="fl">6</span>))
<span class="no">models_tbl_fcast</span></pre></body></html></div>
<pre><code>## # A tibble: 3 x 4
##   f          params           fit        fcast     
##   &lt;chr&gt;      &lt;list&gt;           &lt;list&gt;     &lt;list&gt;    
## 1 auto.arima &lt;named list [1]&gt; &lt;fr_ARIMA&gt; &lt;forecast&gt;
## 2 ets        &lt;named list [2]&gt; &lt;ets&gt;      &lt;forecast&gt;
## 3 bats       &lt;named list [1]&gt; &lt;bats&gt;     &lt;forecast&gt;</code></pre>
</div>
<div id="tidying-the-forecast" class="section level1">
<h1 class="hasAnchor">
<a href="#tidying-the-forecast" class="anchor"></a>Tidying the forecast</h1>
<p>Next, we map <code>sw_sweep</code>, which coerces the forecast into the “tidy” tibble format. We set <code>fitted = FALSE</code> to remove the model fitted values from the output. We set <code>timetk_idx = TRUE</code> to use dates instead of numeric values for the index.</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="no">models_tbl_fcast_tidy</span> <span class="kw">&lt;-</span> <span class="no">models_tbl_fcast</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">sweep</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">fcast</span>, <span class="no">sw_sweep</span>, <span class="kw">fitted</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">timetk_idx</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">rename_index</span> <span class="kw">=</span> <span class="st">"date"</span>))
<span class="no">models_tbl_fcast_tidy</span></pre></body></html></div>
<pre><code>## # A tibble: 3 x 5
##   f          params           fit        fcast      sweep             
##   &lt;chr&gt;      &lt;list&gt;           &lt;list&gt;     &lt;list&gt;     &lt;list&gt;            
## 1 auto.arima &lt;named list [1]&gt; &lt;fr_ARIMA&gt; &lt;forecast&gt; &lt;tibble [112 × 7]&gt;
## 2 ets        &lt;named list [2]&gt; &lt;ets&gt;      &lt;forecast&gt; &lt;tibble [112 × 7]&gt;
## 3 bats       &lt;named list [1]&gt; &lt;bats&gt;     &lt;forecast&gt; &lt;tibble [112 × 7]&gt;</code></pre>
<p>We can unnest the “sweep” column to get the results of all three models.</p>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="no">models_tbl_fcast_tidy</span> <span class="kw">%&gt;%</span>
    <span class="fu">unnest</span>(<span class="no">sweep</span>)</pre></body></html></div>
<pre><code>## # A tibble: 336 x 11
##    f       params   fit    fcast  date       key   price lo.80 lo.95 hi.80 hi.95
##    &lt;chr&gt;   &lt;list&gt;   &lt;list&gt; &lt;list&gt; &lt;date&gt;     &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1990-09-01 actu…  1.26    NA    NA    NA    NA
##  2 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1990-12-01 actu…  1.32    NA    NA    NA    NA
##  3 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1991-03-01 actu…  1.04    NA    NA    NA    NA
##  4 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1991-06-01 actu…  1.13    NA    NA    NA    NA
##  5 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1991-09-01 actu…  1.11    NA    NA    NA    NA
##  6 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1991-12-01 actu…  1.08    NA    NA    NA    NA
##  7 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1992-03-01 actu…  1.01    NA    NA    NA    NA
##  8 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1992-06-01 actu…  1.14    NA    NA    NA    NA
##  9 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1992-09-01 actu…  1.12    NA    NA    NA    NA
## 10 auto.a… &lt;named … &lt;fr_A… &lt;fore… 1992-12-01 actu…  1.08    NA    NA    NA    NA
## # … with 326 more rows</code></pre>
<p>Finally, we can plot the forecasts by unnesting the “sweep” column and piping to <code>ggplot()</code>.</p>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="no">models_tbl_fcast_tidy</span> <span class="kw">%&gt;%</span>
    <span class="fu">unnest</span>(<span class="no">sweep</span>) <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">price</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">key</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">f</span>)) +
    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lo.95</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">hi.95</span>),
                <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"#D5DBFF"</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0</span>) +
    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lo.80</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">hi.80</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">key</span>),
                <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"#596DD5"</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
    <span class="fu">geom_line</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">1</span>) +
    <span class="fu">facet_wrap</span>(~<span class="no">f</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">3</span>) +
    <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Gasoline Price Forecasts"</span>,
         <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Forecasting multiple models with sweep: ARIMA, BATS, ETS"</span>,
         <span class="kw">x</span> <span class="kw">=</span> <span class="st">""</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Price"</span>) +
    <span class="fu">scale_y_continuous</span>(<span class="kw">labels</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/label_dollar.html">dollar</a></span>) +
    <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"5 years"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y"</span>) +
    <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/theme_tq.html">theme_tq</a></span>() +
    <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/scale_manual.html">scale_color_tq</a></span>()</pre></body></html></div>
<p><img src="SW02_Forecasting_Multiple_Models_files/figure-html/unnamed-chunk-23-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="recap" class="section level1">
<h1 class="hasAnchor">
<a href="#recap" class="anchor"></a>Recap</h1>
<p>The <code>sweep</code> package can aid analysis of multiple forecast models. In the next vignette we will review time series object coercion with <code>sweep</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matt Dancho, Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
